## 概述

容器在软件开发生命周期供应链的不同阶段有多种形式，并且带来了独特的安全挑战。单个容器可能依赖于数百个第三方组件和依赖项，这使得每个阶段的软件来源都很难值得信任。这些挑战包括但不限于镜像的完整性、镜像的合成和已知的软件漏洞。

## 问题描述

**镜像完整性：** 由于诸如 [太阳风黑客攻击事件](https://www.businessinsider.com/solarwinds-hack-explained-government-agencies-cyber-security-2020-12) 和各种 [植入恶意软件的第三方软件包](https://therecord.media/malware-found-in-npm-package-with-millions-of-weekly-downloads/) 问题频发，软件来源最近引起了媒体的极大关注。
这些供应链风险可能在容器构建生命周期的各阶段以及Kubernetes的内部运行时出现。如果容器镜像的内容记录系统不存在，则集群中可能会运行一个非预期内的容器。

**镜像合成：** 容器镜像由层（layers）组成，每一层都可能产生安全影响。构建方式合理的容器镜像不仅可以减少攻击面，还可以提高部署效率。使用带有外部软件的镜像可能会导致特权提升或对已知漏洞的利用。

**已知软件漏洞：** 由于使用了大量的第三方程序包，许多容器镜像在被拉取到可信环境并运行时存在内置的风险。例如，如果镜像包含了已知漏洞版本的OpenSSL，则可能会将其传播到多个工作负载，并在不知不觉中将整个群集置于危险之中。

## 防范策略

**镜像完整性：** 可以将容器镜像视为从生产者传递给消费者的一系列软件制品和元数据。其交付过程可以简单到从开发人员的IDE直接向Kubernetes集群部署，也可以复杂到通过多步骤的专用CI/CD流水线完成。软件的完整性应通过以下各个阶段的验证来进行:

**软件物料清单（SBOM）：** SBOM提供了给定软件制品所包含的软件包、许可证和库的列表，因此应作为其他安全检查的起点。两个最流行的SBOM生成开放标准包括  [CycloneDX](https://cyclonedx.org/) 和 [SPDX](https://spdx.dev/) 。

**镜像签名：** DevOps 流水线中的每个步骤都可能引入攻击或意外的后果。生产者和消费者在供应链的每一步都应该使用加密的密钥对来签名和验证制品，以检测制品本身是否被篡改。 [Cosign](https://github.com/sigstore/cosign) 项目是一个用于容器镜像验证的开源项目。

**镜像组合：** 容器镜像应该使用最小化的操作系统和依赖项来创建，以便在工作负载受到安全危害时减少攻击面。考虑使用基础镜像的替代物，如 [Distroless](https://github.com/GoogleContainerTools/distroless) 或 [Scratch](https://hub.docker.com/_/scratch) ，不仅可以改善安全状况，还可以大大减少漏洞扫描器产生的误报干扰。确保基础镜像使用最新的安全补丁也很重要，基于性能和安全原因，可以使用 [Docker Slim](https://github.com/docker-slim/docker-slim)等工具来优化镜像占用空间。

**已知软件安全漏洞：** Image vulnerability scanning aims to enumerate known security issues in container images and should be used as a first line of defense. ****You can identify all upstream software with vulnerabilities simply by looking for images built with a specific layer. Images should be patched quickly by simply replacing the layer containing the vulnerability and rebuilding the container to use up-to-date, fixed packages. Open source tools such as [Clair](https://github.com/coreos/clair) will statically analyze container images for known vulnerabilities such as CVEs and should be used as early in the development cycle as reasonably possible. 
镜像漏洞扫描旨在列举容器镜像中的已知安全问题，应作为第一道防线。只需查找镜像构建中的特定层，就可以识别出携带漏洞的全部上游软件。只需通过简单的替换包含漏洞的层并使用最新的、固定的包来重新构建即可快速修补容器镜像。应在开发周期中尽早使用 [Clair](https://github.com/coreos/clair) 等开源工具进行容器镜像的静态分析以找出已知的漏洞，比如CVE等。

**执行策略：** 通过Kubernetes的[准入控制机制](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/) （admission controls）阻止未经批准的镜像，以及与策略引擎（如 [Open Policy Agent](https://www.openpolicyagent.org/) 和 [Kyverno](https://kyverno.io) ）联合使用，以拒绝不满足要求的镜像：

- 未进行过安全扫描
- 使用了未被明确允许的基础镜像
- 未包含SBOM声明
- 来源不受信任

## 典型攻击场景

案例 #1: 不安全的 CI/CD 流水线

大多数团队使用自动化流程来构建容器镜像并将其推送到中央仓库，然后按照对象描述文件（object manifest）从Kubernetes中拉取镜像。如果构建系统受到威胁且恶意程序作为构建过程的一部分被注入，则Kubernetes将镜像拉取到集群中运行时可能会执行恶意软件，例如安装挖矿软件、植入后门等。

## 参考资料
准入控制器（Admission Controllers）: [https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/)

Co-Sign: [https://github.com/sigstore/cosign](https://github.com/sigstore/cosign)

CycloneDX: [https://owasp.org/www-project-cyclonedx/](https://owasp.org/www-project-cyclonedx/)

Docker Slim: [https://github.com/docker-slim/docker-slim](https://github.com/docker-slim/docker-slim)

Open Policy Agent: [https://www.openpolicyagent.org/](https://www.openpolicyagent.org/)

